<script>
  let rooms = [];
  let walls = [];
  let doors = [];
  let windowsArr = [];

  // Load previous project data (from page1.html)
  let projectData = JSON.parse(localStorage.getItem('boq_project') || '{}');
  if (projectData.rooms) rooms = projectData.rooms;
  if (projectData.walls) walls = projectData.walls;
  if (projectData.doors) doors = projectData.doors;
  if (projectData.windows) windowsArr = projectData.windows;

  // ---------- SAVE FUNCTION ----------
  function saveData() {
    projectData.rooms = rooms;
    projectData.walls = walls;
    projectData.doors = doors;
    projectData.windows = windowsArr;
    localStorage.setItem('boq_project', JSON.stringify(projectData));
  }

  // ---------- ROOMS ----------
  function addRoom() {
    const name = document.getElementById('roomName').value.trim();
    if (!name) return;
    if (rooms.includes(name)) { alert("Room name already exists!"); return; }
    rooms.push(name);
    saveData();
    updateRoomList();
    document.getElementById('roomName').value = '';
    updateWallRoomOptions();
  }

  function updateRoomList() {
    const list = document.getElementById('roomList');
    list.innerHTML = '';
    rooms.forEach((r, i) => {
      list.innerHTML += `<div class="list-item">
        <span id="room-${i}">${r}</span>
        <div class="action-buttons">
          <button class="edit-btn" onclick="editRoom(${i})">Edit</button>
          <button class="delete-btn" onclick="deleteRoom(${i})">Del</button>
        </div></div>`;
    });
  }

  function deleteRoom(i) {
    rooms.splice(i,1);
    saveData();
    updateRoomList();
    updateWallRoomOptions();
  }

  function editRoom(i) {
    const span = document.getElementById(`room-${i}`);
    const oldValue = rooms[i];
    span.innerHTML = `<input type="text" id="edit-room-${i}" value="${oldValue}" style="width:90%">`;
    const input = document.getElementById(`edit-room-${i}`);
    input.focus();
    input.onblur = () => { 
      rooms[i] = input.value.trim() || oldValue; 
      saveData();
      updateRoomList(); 
      updateWallRoomOptions(); 
    };
  }

  function updateWallRoomOptions() {
    const select = document.getElementById('wallRoom');
    select.innerHTML = rooms.map(r => `<option value="${r}">${r}</option>`).join('');
  }

  // ---------- WALLS ----------
  function addWall() {
    const name = document.getElementById('wallName').value.trim();
    const length = document.getElementById('wallLength').value;
    const height = document.getElementById('wallHeight').value;
    const unit = document.getElementById('wallUnit').value;
    const room = document.getElementById('wallRoom').value;
    if (!name || !length || !height || !room) return;
    walls.push({name, length, height, unit, room});
    saveData();
    updateWallList();
    document.getElementById('wallName').value = '';
    document.getElementById('wallLength').value = '';
    document.getElementById('wallHeight').value = '';
    updateWallOptions();
  }

  function updateWallList() {
    const list = document.getElementById('wallList');
    list.innerHTML = '';
    walls.forEach((w, i) => {
      list.innerHTML += `<div class="list-item">
        <span id="wall-${i}">${w.name} - ${w.length}x${w.height} ${w.unit} (Room: ${w.room})</span>
        <div class="action-buttons">
          <button class="edit-btn" onclick="editWall(${i})">Edit</button>
          <button class="delete-btn" onclick="deleteWall(${i})">Del</button>
        </div></div>`;
    });
  }

  function deleteWall(i) { 
    walls.splice(i,1); 
    saveData();
    updateWallList(); 
    updateWallOptions(); 
  }

  function editWall(i) {
    const span = document.getElementById(`wall-${i}`);
    const w = walls[i];
    span.innerHTML = `<input type="text" id="edit-wall-${i}" value="${w.name}" style="width:90%">`;
    const input = document.getElementById(`edit-wall-${i}`);
    input.focus();
    input.onblur = () => { 
      walls[i].name = input.value.trim() || w.name; 
      saveData();
      updateWallList(); 
    };
  }

  function updateWallOptions() {
    const doorSel = document.getElementById('doorWall');
    const winSel = document.getElementById('windowWall');
    doorSel.innerHTML = walls.map(w => `<option value="${w.name}">${w.name} (${w.room})</option>`).join('');
    winSel.innerHTML = doorSel.innerHTML;
  }

  // ---------- DOORS ----------
  function addDoor() {
    const name = document.getElementById('doorName').value.trim();
    const width = document.getElementById('doorWidth').value;
    const height = document.getElementById('doorHeight').value;
    const unit = document.getElementById('doorUnit').value;
    const wall = document.getElementById('doorWall').value;
    if (!name || !width || !height || !wall) return;
    doors.push({name, width, height, unit, wall});
    saveData();
    updateDoorList();
    document.getElementById('doorName').value = '';
  }

  function updateDoorList() {
    const list = document.getElementById('doorList');
    list.innerHTML = '';
    doors.forEach((d, i) => {
      list.innerHTML += `<div class="list-item">
        <span id="door-${i}">${d.name} - ${d.width}x${d.height} ${d.unit} (Wall: ${d.wall})</span>
        <div class="action-buttons">
          <button class="edit-btn" onclick="editDoor(${i})">Edit</button>
          <button class="delete-btn" onclick="deleteDoor(${i})">Del</button>
        </div></div>`;
    });
  }

  function deleteDoor(i) { doors.splice(i,1); saveData(); updateDoorList(); }
  function editDoor(i) {
    const span = document.getElementById(`door-${i}`);
    const d = doors[i];
    span.innerHTML = `<input type="text" id="edit-door-${i}" value="${d.name}" style="width:90%">`;
    const input = document.getElementById(`edit-door-${i}`);
    input.focus();
    input.onblur = () => { doors[i].name = input.value.trim() || d.name; saveData(); updateDoorList(); };
  }

  // ---------- WINDOWS ----------
  function addWindow() {
    const name = document.getElementById('windowName').value.trim();
    const width = document.getElementById('windowWidth').value;
    const height = document.getElementById('windowHeight').value;
    const unit = document.getElementById('windowUnit').value;
    const wall = document.getElementById('windowWall').value;
    if (!name || !width || !height || !wall) return;
    windowsArr.push({name, width, height, unit, wall});
    saveData();
    updateWindowList();
    document.getElementById('windowName').value = '';
  }

  function updateWindowList() {
    const list = document.getElementById('windowList');
    list.innerHTML = '';
    windowsArr.forEach((w, i) => {
      list.innerHTML += `<div class="list-item">
        <span id="window-${i}">${w.name} - ${w.width}x${w.height} ${w.unit} (Wall: ${w.wall})</span>
        <div class="action-buttons">
          <button class="edit-btn" onclick="editWindow(${i})">Edit</button>
          <button class="delete-btn" onclick="deleteWindow(${i})">Del</button>
        </div></div>`;
    });
  }

  function deleteWindow(i) { windowsArr.splice(i,1); saveData(); updateWindowList(); }
  function editWindow(i) {
    const span = document.getElementById(`window-${i}`);
    const w = windowsArr[i];
    span.innerHTML = `<input type="text" id="edit-window-${i}" value="${w.name}" style="width:90%">`;
    const input = document.getElementById(`edit-window-${i}`);
    input.focus();
    input.onblur = () => { windowsArr[i].name = input.value.trim() || w.name; saveData(); updateWindowList(); };
  }

  // ---------- NAVIGATION ----------
  function nextStep(n) {
    document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
    document.getElementById('step'+n).classList.remove('hidden');
    if (n === 5) generatePreview();
  }
  function prevStep(n) { nextStep(n); }

  function generatePreview() {
    let summary = '';
    rooms.forEach(r => {
      const rWalls = walls.filter(w => w.room === r);
      const rDoors = doors.filter(d => rWalls.some(w => w.name === d.wall));
      const rWindows = windowsArr.filter(wi => rWalls.some(w => w.name === wi.wall));
      summary += `<div class="list-item"><strong>${r}</strong>: 
        ${rWalls.length} Walls, ${rDoors.length} Doors, ${rWindows.length} Windows</div>`;
    });
    document.getElementById('preview').innerHTML = summary;
  }

  // ---------- INIT ----------
  updateRoomList();
  updateWallList();
  updateDoorList();
  updateWindowList();
  updateWallRoomOptions();
  updateWallOptions();
</script>
